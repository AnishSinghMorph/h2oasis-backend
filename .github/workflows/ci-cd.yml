name: ğŸš€ CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

env:
  NODE_VERSION: '18'

jobs:
  # ===== LINT & TEST =====
  test:
    name: ğŸ§ª Test & Lint
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout Code
      uses: actions/checkout@v4
      
    - name: ğŸŸ¢ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        
    - name: ğŸ“¦ Install Dependencies
      run: npm ci
      
    - name: ğŸ” Lint Code
      run: npm run lint || echo "No lint script found, skipping..."
      
    - name: ğŸ”¨ Build TypeScript
      run: npm run build
      
    - name: ğŸ§ª Run Tests
      run: npm test || echo "No tests found, skipping..."
      
    - name: ğŸ“Š Upload Coverage
      uses: codecov/codecov-action@v3
      if: success()
      
  # ===== SECURITY SCAN =====
  security:
    name: ğŸ”’ Security Scan
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout Code
      uses: actions/checkout@v4
      
    - name: ğŸŸ¢ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        
    - name: ğŸ“¦ Install Dependencies
      run: npm ci
      
    - name: ğŸ” Security Audit
      run: npm audit --audit-level moderate
      
    - name: ğŸ›¡ï¸ Dependency Check
      run: npx better-npm-audit audit --level moderate
      continue-on-error: true

  # ===== BUILD & DEPLOY =====
  deploy:
    name: ğŸš€ Deploy to Firebase
    runs-on: ubuntu-latest
    needs: [test, security]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
    - name: ğŸ“¥ Checkout Code
      uses: actions/checkout@v4
      
    - name: ğŸŸ¢ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        
    - name: ğŸ“¦ Install Dependencies
      run: npm ci
      
    - name: ğŸ”¨ Build Project
      run: npm run build
      
    - name: ğŸ”¥ Deploy to Firebase Functions
      env:
        FIREBASE_SERVICE_ACCOUNT: ${{ secrets.FIREBASE_SERVICE_ACCOUNT_H2OASIS_74D5B }}
      run: |
        npm install -g firebase-tools
        echo "$FIREBASE_SERVICE_ACCOUNT" > firebase-service-account.json
        export GOOGLE_APPLICATION_CREDENTIALS=firebase-service-account.json
        firebase deploy --only functions --project h2oasis-74d5b --non-interactive
        rm firebase-service-account.json
        
  # ===== NOTIFICATION =====
  notify:
    name: ğŸ“¢ Notify Status
    runs-on: ubuntu-latest
    needs: [test, security, deploy]
    if: always()
    
    steps:
    - name: ğŸ‰ Success Notification
      if: ${{ needs.test.result == 'success' && needs.security.result == 'success' }}
      run: |
        echo "âœ… Pipeline completed successfully!"
        echo "ğŸš€ Deployment status: ${{ needs.deploy.result }}"
        
    - name: âŒ Failure Notification
      if: ${{ needs.test.result == 'failure' || needs.security.result == 'failure' }}
      run: |
        echo "âŒ Pipeline failed!"
        echo "ğŸ§ª Tests: ${{ needs.test.result }}"
        echo "ğŸ”’ Security: ${{ needs.security.result }}"
